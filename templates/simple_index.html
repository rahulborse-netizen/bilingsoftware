<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Tennis Lessons - Enhanced Billing</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* MOBILE-FIRST DESIGN - ENHANCED */
        body {
            font-size: 22px !important;
            font-family: Arial, sans-serif;
            background-color: #f0f8ff;
            padding-bottom: 100px; /* Space for bottom nav */
            touch-action: pan-y;
        }
        
        h1 {
            font-size: 42px !important;
            font-weight: bold;
            color: #2c3e50;
        }
        
        h2 {
            font-size: 32px !important;
            font-weight: bold;
        }
        
        h3 {
            font-size: 28px !important;
        }
        
        /* HUGE BUTTONS - Mobile Optimized */
        .btn-huge {
            font-size: 28px !important;
            padding: 25px 50px !important;
            margin: 10px;
            min-height: 100px;
            font-weight: bold;
            border-radius: 15px !important;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: all 0.2s;
        }
        
        .btn-huge:active {
            transform: scale(0.95);
        }
        
        .btn-add {
            background-color: #28a745 !important;
            color: white !important;
            border: 3px solid #1e7e34 !important;
        }
        
        /* LARGE FORM INPUTS */
        .form-control, .form-select {
            font-size: 24px !important;
            padding: 18px !important;
            border: 3px solid #ced4da !important;
            border-radius: 10px !important;
            min-height: 70px;
        }
        
        .form-label {
            font-size: 26px !important;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        /* CARD STYLING - Mobile-First */
        .card {
            border: 3px solid #dee2e6 !important;
            border-radius: 15px !important;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        
        .card-header {
            font-size: 30px !important;
            font-weight: bold;
            padding: 20px !important;
            background-color: #007bff !important;
            color: white !important;
            border-radius: 12px 12px 0 0 !important;
        }
        
        .card-body {
            padding: 25px !important;
        }
        
        /* MOBILE CARD-BASED LAYOUT for lessons */
        .lesson-card {
            border: 3px solid #dee2e6;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s;
            position: relative;
        }
        
        .lesson-card:active {
            transform: scale(0.98);
        }
        
        .lesson-card.swiping-left {
            transform: translateX(-80px);
        }
        
        .lesson-card.swiping-right {
            transform: translateX(80px);
        }
        
        .lesson-student {
            font-size: 28px;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 10px;
        }
        
        .lesson-time {
            font-size: 22px;
            color: #6c757d;
            margin-bottom: 5px;
        }
        
        .lesson-amount {
            font-size: 32px;
            font-weight: bold;
            color: #28a745;
            margin: 10px 0;
        }
        
        .lesson-coach {
            font-size: 18px;
            color: #6c757d;
            margin-bottom: 5px;
        }
        
        .lesson-package-info {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 10px;
            margin-top: 10px;
            font-size: 18px;
        }
        
        .lesson-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .lesson-actions button {
            flex: 1;
            font-size: 20px;
            padding: 12px;
            min-height: 60px;
            border-radius: 10px;
            font-weight: bold;
        }
        
        /* TOTAL BOXES */
        .total-box {
            background-color: #28a745;
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            font-size: 32px;
            font-weight: bold;
            margin: 15px 0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .month-box {
            background-color: #007bff;
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            font-size: 32px;
            font-weight: bold;
            margin: 15px 0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        /* ALERT BOXES for package expiry */
        .alert-banner {
            background: #dc3545;
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            font-size: 22px;
            font-weight: bold;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        
        /* BOTTOM NAVIGATION - Mobile App Style */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 3px solid #dee2e6;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            box-shadow: 0 -4px 8px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        
        .bottom-nav-item {
            flex: 1;
            text-align: center;
            text-decoration: none;
            color: #6c757d;
            padding: 10px;
            font-size: 16px;
            transition: all 0.2s;
            position: relative;
        }
        
        .bottom-nav-item:hover, .bottom-nav-item.active {
            color: #007bff;
            transform: scale(1.1);
        }
        
        .bottom-nav-icon {
            font-size: 32px;
            display: block;
            margin-bottom: 5px;
        }
        
        .badge-notify {
            position: absolute;
            top: 5px;
            right: 15px;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            padding: 4px 8px;
            font-size: 14px;
            font-weight: bold;
        }
        
        /* FLOATING ADD BUTTON */
        .fab {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 80px;
            height: 80px;
            background: #28a745;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            cursor: pointer;
            z-index: 999;
            transition: all 0.3s;
        }
        
        .fab:active {
            transform: scale(0.9);
        }
        
        /* MODAL */
        .modal-dialog {
            max-width: 95% !important;
            margin: 10px;
        }
        
        .modal-title {
            font-size: 30px !important;
        }
        
        .modal-body {
            font-size: 22px !important;
        }
        
        /* ACTION BUTTONS */
        .action-button {
            font-size: 20px !important;
            padding: 15px 25px !important;
            margin: 5px;
            min-height: 60px;
            border-radius: 10px !important;
            font-weight: bold;
        }
        
        /* Package select helper */
        .package-selector {
            background: #e7f3ff;
            border: 3px solid #007bff;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            font-size: 20px;
        }
        
        .package-balance-preview {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
            margin: 10px 0;
        }
        
        /* Desktop adjustments */
        @media (min-width: 768px) {
            .lesson-card {
                display: none; /* Hide mobile cards on desktop */
            }
            
            .desktop-table {
                display: table !important;
            }
            
            .fab {
                display: none; /* Hide floating button on desktop */
            }
        }
        
        @media (max-width: 767px) {
            .desktop-table {
                display: none !important;
            }
            
            h1 {
                font-size: 36px !important;
            }
            
            .modal-dialog {
                margin: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid py-3">
        <!-- Top Header -->
        <div class="row mb-3">
            <div class="col-12">
                <h1>üéæ Tennis Lessons</h1>
                <div style="font-size: 18px; color: #6c757d;">{{ today_date.strftime('%B %d, %Y') }}</div>
            </div>
        </div>
        
        <!-- Package Expiring Alerts -->
        {% if expiring_packages %}
        <div class="row">
            <div class="col-12">
                {% for package in expiring_packages %}
                <div class="alert-banner" onclick="location.href='/packages'">
                    ‚ö†Ô∏è PACKAGE EXPIRING!<br>
                    {{ package.customer_name }}: {{ package.classes_remaining }} class{% if package.classes_remaining != 1 %}es{% endif %} left
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <!-- Import/Export Buttons -->
        <div class="row mb-3">
            <div class="col-12">
                <button class="btn btn-warning action-button" onclick="document.getElementById('importFile').click()">
                    üì• Import
                </button>
                <input type="file" id="importFile" accept=".xlsx" style="display:none" onchange="importExcel(this)">
                
                <a href="/export_excel" class="btn btn-success action-button">
                    üì§ Export
                </a>
                
                <button class="btn btn-info action-button" onclick="exportCurrentMonth()">
                    üìä Export Month
                </button>
            </div>
        </div>
        
        <!-- Totals -->
        <div class="row">
            <div class="col-md-6">
                <div class="total-box">
                    <div style="font-size: 22px;">Today's Total</div>
                    <div style="font-size: 48px; margin-top: 10px;">
                        ${{ "%.2f"|format(today_total) }}
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="month-box">
                    <div style="font-size: 22px;">This Month</div>
                    <div style="font-size: 48px; margin-top: 10px;">
                        ${{ "%.2f"|format(month_total) }}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Add Lesson Button (Desktop) -->
        <div class="row mb-3 d-none d-md-block">
            <div class="col-12 text-center">
                <button class="btn btn-add btn-huge" onclick="openAddLesson()">
                    ‚ûï ADD NEW LESSON
                </button>
            </div>
        </div>
        
        <!-- Today's Lessons -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        üìÖ Today's Lessons ({{ today_lessons|length }})
                    </div>
                    <div class="card-body">
                        {% if today_lessons %}
                        
                        <!-- Desktop Table View -->
                        <div class="table-responsive desktop-table">
                            <table class="table table-striped table-hover" style="font-size: 22px;">
                                <thead>
                                    <tr style="font-size: 24px; font-weight: bold;">
                                        <th>Time</th>
                                        <th>Student</th>
                                        <th>Coach</th>
                                        <th>Hours</th>
                                        <th>Amount</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for lesson in today_lessons %}
                                    <tr>
                                        <td><strong>{{ lesson.time }}</strong></td>
                                        <td><strong>{{ lesson.student_name }}</strong></td>
                                        <td>{{ lesson.coach.name if lesson.coach else '-' }}</td>
                                        <td>{{ lesson.hours }} hrs</td>
                                        <td style="color: #28a745; font-weight: bold; font-size: 26px;">
                                            ${{ "%.2f"|format(lesson.invoice_amount) }}
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-warning" style="font-size: 18px; padding: 8px 16px;" onclick="editLesson({{ lesson.to_dict()|tojson }})">
                                                ‚úèÔ∏è Edit
                                            </button>
                                            <button class="btn btn-sm btn-danger" style="font-size: 18px; padding: 8px 16px;" onclick="deleteLesson({{ lesson.id }})">
                                                üóëÔ∏è Delete
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Mobile Card View -->
                        {% for lesson in today_lessons %}
                        <div class="lesson-card" data-id="{{ lesson.id }}" ontouchstart="handleTouchStart(event, {{ lesson.id }})" ontouchmove="handleTouchMove(event)" ontouchend="handleTouchEnd(event)">
                            <div class="lesson-student">{{ lesson.student_name }}</div>
                            <div class="lesson-time">üïê {{ lesson.time }}</div>
                            {% if lesson.coach %}
                            <div class="lesson-coach">üë®‚Äçüè´ Coach: {{ lesson.coach.name }}</div>
                            {% endif %}
                            <div class="lesson-time">‚è±Ô∏è {{ lesson.hours }} hour{% if lesson.hours != 1 %}s{% endif %}</div>
                            <div class="lesson-amount">${{ "%.2f"|format(lesson.invoice_amount) }}</div>
                            
                            {% if lesson.deducted_from_package and lesson.student_package %}
                            <div class="lesson-package-info">
                                üì¶ From Package: {{ lesson.student_package.classes_remaining }} classes left
                            </div>
                            {% endif %}
                            
                            <div class="lesson-actions">
                                <button class="btn btn-warning" onclick="editLesson({{ lesson.to_dict()|tojson }})">
                                    ‚úèÔ∏è Edit
                                </button>
                                <button class="btn btn-danger" onclick="deleteLesson({{ lesson.id }})">
                                    üóëÔ∏è Delete
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                        
                        {% else %}
                        <div class="alert alert-info" style="font-size: 24px;">
                            üìù No lessons recorded for today yet. Tap the + button to add one!
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Floating Add Button (Mobile) -->
    <div class="fab d-md-none" onclick="openAddLesson()">
        ‚ûï
    </div>
    
    <!-- Add/Edit Lesson Modal -->
    <div class="modal fade" id="lessonModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalTitle">Add New Lesson</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" style="font-size: 30px;"></button>
                </div>
                <div class="modal-body">
                    <form id="lessonForm">
                        <input type="hidden" id="lessonId">
                        <input type="hidden" id="packageId">
                        
                        <div class="mb-3">
                            <label class="form-label">üìÖ Date:</label>
                            <input type="date" class="form-control" id="lessonDate" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">üïê Time:</label>
                            <input type="text" class="form-control" id="lessonTime" placeholder="e.g., 4-5 pm" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">üë§ Student Name:</label>
                            <input type="text" class="form-control" id="studentName" list="studentsList" onchange="checkPackage()" required>
                            <datalist id="studentsList"></datalist>
                        </div>
                        
                        <div id="packageInfo" style="display: none;" class="package-selector">
                            <strong>üì¶ Active Package Found!</strong>
                            <div id="packageDetails"></div>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" id="usePackage" onchange="togglePackageUse()" style="width: 30px; height: 30px;">
                                <label class="form-check-label" for="usePackage" style="margin-left: 10px; font-size: 22px;">
                                    Deduct from package
                                </label>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">üë®‚Äçüè´ Coach/Instructor:</label>
                            <select class="form-select" id="coachId">
                                <option value="">-- Select Coach --</option>
                                {% for coach in coaches %}
                                <option value="{{ coach.id }}">{{ coach.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">‚è±Ô∏è Hours:</label>
                            <input type="number" step="0.5" class="form-control" id="lessonHours" value="1.0" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">üì¶ Package/Note (Optional):</label>
                            <input type="text" class="form-control" id="lessonPackage">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">üíµ Amount ($):</label>
                            <input type="number" step="0.01" class="form-control" id="invoiceAmount" required>
                        </div>
                        
                        <div id="packageWarning" style="display: none;" class="alert alert-warning" style="font-size: 20px;">
                            ‚ö†Ô∏è <strong>WARNING:</strong> This is the LAST class in the package!
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary action-button" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success action-button" onclick="saveLesson()">üíæ Save</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <a href="/" class="bottom-nav-item active">
            <span class="bottom-nav-icon">üè†</span>
            <div>Home</div>
        </a>
        <a href="/packages" class="bottom-nav-item">
            <span class="bottom-nav-icon">üì¶</span>
            <div>Packages</div>
        </a>
        <a href="/coaches" class="bottom-nav-item">
            <span class="bottom-nav-icon">üë®‚Äçüè´</span>
            <div>Coaches</div>
        </a>
        <a href="/notifications" class="bottom-nav-item">
            <span class="bottom-nav-icon">üîî</span>
            <div>Alerts</div>
            {% if unread_notifications > 0 %}
            <span class="badge-notify">{{ unread_notifications }}</span>
            {% endif %}
        </a>
        <a href="/history" class="bottom-nav-item">
            <span class="bottom-nav-icon">üìä</span>
            <div>History</div>
        </a>
    </div>
    
    <!-- Success Toast -->
    <div class="toast-container position-fixed top-0 end-0 p-3">
        <div id="successToast" class="toast align-items-center text-white bg-success border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body" style="font-size: 22px;"></div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/mobile.js') }}"></script>
    <script>
        let currentPackage = null;
        
        function openAddLesson() {
            document.getElementById('modalTitle').textContent = 'Add New Lesson';
            document.getElementById('lessonForm').reset();
            document.getElementById('lessonId').value = '';
            document.getElementById('packageId').value = '';
            document.getElementById('lessonDate').valueAsDate = new Date();
            document.getElementById('packageInfo').style.display = 'none';
            currentPackage = null;
            loadStudentNames();
            new bootstrap.Modal(document.getElementById('lessonModal')).show();
        }
        
        function loadStudentNames() {
            fetch('/api/students/search?q=')
                .then(r => r.json())
                .then(data => {
                    const datalist = document.getElementById('studentsList');
                    datalist.innerHTML = '';
                    data.students.forEach(name => {
                        const option = document.createElement('option');
                        option.value = name;
                        datalist.appendChild(option);
                    });
                });
        }
        
        function checkPackage() {
            const studentName = document.getElementById('studentName').value.trim();
            if (!studentName) return;
            
            fetch(`/api/packages/check/${encodeURIComponent(studentName)}`)
                .then(r => r.json())
                .then(data => {
                    if (data.has_package) {
                        currentPackage = data.package;
                        document.getElementById('packageId').value = currentPackage.id;
                        document.getElementById('packageInfo').style.display = 'block';
                        
                        const details = `
                            <div style="margin-top: 10px;">
                                <div><strong>${currentPackage.package_name}</strong></div>
                                <div>Classes Remaining: <strong>${currentPackage.classes_remaining}</strong></div>
                                <div>Balance: <strong>$${currentPackage.balance_remaining.toFixed(2)}</strong></div>
                                <div>Price per Class: <strong>$${currentPackage.amount_per_class.toFixed(2)}</strong></div>
                            </div>
                        `;
                        document.getElementById('packageDetails').innerHTML = details;
                        document.getElementById('usePackage').checked = true;
                        document.getElementById('invoiceAmount').value = currentPackage.amount_per_class.toFixed(2);
                        
                        if (currentPackage.classes_remaining <= 1) {
                            document.getElementById('packageWarning').style.display = 'block';
                        } else {
                            document.getElementById('packageWarning').style.display = 'none';
                        }
                    } else {
                        document.getElementById('packageInfo').style.display = 'none';
                        document.getElementById('packageId').value = '';
                        currentPackage = null;
                    }
                });
        }
        
        function togglePackageUse() {
            const usePackage = document.getElementById('usePackage').checked;
            if (usePackage && currentPackage) {
                document.getElementById('invoiceAmount').value = currentPackage.amount_per_class.toFixed(2);
            }
        }
        
        function editLesson(lessonData) {
            document.getElementById('modalTitle').textContent = 'Edit Lesson';
            document.getElementById('lessonId').value = lessonData.id;
            document.getElementById('lessonDate').value = lessonData.date;
            document.getElementById('lessonTime').value = lessonData.time;
            document.getElementById('studentName').value = lessonData.student_name;
            document.getElementById('lessonHours').value = lessonData.hours;
            document.getElementById('lessonPackage').value = lessonData.package || '';
            document.getElementById('invoiceAmount').value = lessonData.invoice_amount;
            document.getElementById('coachId').value = lessonData.coach_id || '';
            new bootstrap.Modal(document.getElementById('lessonModal')).show();
        }
        
        function saveLesson() {
            const id = document.getElementById('lessonId').value;
            const usePackage = document.getElementById('usePackage')?.checked;
            
            const data = {
                date: document.getElementById('lessonDate').value,
                time: document.getElementById('lessonTime').value,
                student_name: document.getElementById('studentName').value,
                hours: document.getElementById('lessonHours').value,
                package: document.getElementById('lessonPackage').value,
                invoice_amount: document.getElementById('invoiceAmount').value,
                coach_id: document.getElementById('coachId').value || null,
                package_id: (usePackage && currentPackage) ? currentPackage.id : null
            };
            
            const url = id ? `/api/lessons/${id}` : '/api/lessons';
            const method = id ? 'PUT' : 'POST';
            
            fetch(url, {
                method: method,
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(() => {
                showToast('‚úÖ Lesson saved successfully!');
                bootstrap.Modal.getInstance(document.getElementById('lessonModal')).hide();
                setTimeout(() => location.reload(), 1000);
            });
        }
        
        function deleteLesson(id) {
            if (confirm('Are you sure you want to delete this lesson?')) {
                fetch(`/api/lessons/${id}`, {method: 'DELETE'})
                .then(() => {
                    showToast('‚úÖ Lesson deleted!');
                    setTimeout(() => location.reload(), 1000);
                });
            }
        }
        
        function importExcel(input) {
            const file = input.files[0];
            if (!file) return;
            
            const formData = new FormData();
            formData.append('file', file);
            
            fetch('/import_excel', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(`‚úÖ Imported ${data.imported} lessons!`);
                    setTimeout(() => location.reload(), 1500);
                } else {
                    alert('Error: ' + data.error);
                }
            });
        }
        
        function exportCurrentMonth() {
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth() + 1;
            window.location.href = `/api/export_monthly/${year}/${month}`;
        }
        
        function showToast(message) {
            const toast = document.getElementById('successToast');
            toast.querySelector('.toast-body').textContent = message;
            new bootstrap.Toast(toast, {delay: 3000}).show();
        }
    </script>
</body>
</html>
